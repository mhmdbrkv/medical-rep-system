generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String    @id @default(uuid())
  name                String
  email               String    @unique
  phone               String
  role                Role      @default(MEDICAL_REP)
  password            String
  dateOfBirth         DateTime
  dateOfRecruitment   DateTime  @default(now())
  department          String?
  location            String?
  bio                 String?
  educationBackground String?
  iqamaNumber         String?
  passportNumber      String?
  resume              String?
  certificates        String?
  lastLogin           DateTime?
  subRegionId         String?

  subRegion    SubRegion? @relation(fields: [subRegionId], references: [id])
  supervisorId String? // Reps belong to a supervisor
  managerId    String?
  supervisor   User?      @relation("SupervisorToReps", fields: [supervisorId], references: [id])
  manager      User?      @relation("manager", fields: [managerId], references: [id])
  reps         User[]     @relation("SupervisorToReps")
  visits       Visit[]
  requests     Request[]

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  regions      Region[]
  visitReports VisitReport[]
  plans        Plan[]        @relation("planCreatedBy")
  repPlans     Plan[]        @relation("planToRep")
  users        User[]        @relation("manager")
}

enum Role {
  MANAGER
  SUPERVISOR
  MEDICAL_REP
}

model Plan {
  id                 String     @id @default(uuid())
  title              String     @unique
  type               PlanType
  status             PlanStatus @default(PENDING)
  description        String
  startDate          DateTime
  endDate            DateTime
  doctors            Doctor[]
  targetDoctors      Int
  targetVisits       Int
  objectives         String[]
  supervisorFeedback String?

  createdBy   User   @relation("planCreatedBy", fields: [createdById], references: [id])
  rep         User   @relation("planToRep", fields: [repId], references: [id])
  createdById String
  repId       String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PlanStatus {
  APPROVED
  PENDING
  REJECTED
}

enum PlanType {
  WEEKLY
  MONTHLY
}

model Visit {
  id        String      @id @default(uuid())
  samples   String[]
  date      DateTime
  time      String
  doctor    Doctor      @relation(fields: [doctorId], references: [id])
  doctorId  String
  createdBy User        @relation(fields: [userId], references: [id])
  userId    String
  notes     String?
  status    VisitStatus @default(SCHEDULED)

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  visitReports VisitReport[]
}

enum VisitStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
}

model VisitReport {
  id              String   @id @default(uuid())
  visitId         String
  userId          String
  duration        String
  rating          String
  discussedTopics String[]
  doctorFeedback  String?
  visitPurpose    String
  notes           String?
  samplesProvided String[]

  createdBy User  @relation(fields: [userId], references: [id])
  visit     Visit @relation(fields: [visitId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Request {
  id           String        @id @default(uuid())
  title        String
  userId       String
  type         RequestType
  status       RequestStatus @default(PENDING)
  urgency      String
  subject      String
  description  String
  response     String?
  responseDate DateTime?

  handledAt DateTime?

  user User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum RequestType {
  EXPENSE
  MARKETING
  SAMPLE
  LEAVE
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model Region {
  id      String @id @default(uuid())
  name    String
  country String
  userId  String

  supervisor User        @relation(fields: [userId], references: [id])
  subRegions SubRegion[]
  doctors    Doctor[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SubRegion {
  id       String @id @default(uuid())
  name     String
  regionId String @unique

  region Region @relation(fields: [regionId], references: [id])
  reps   User[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Doctor {
  id                String   @id @default(uuid())
  name              String
  email             String
  phone             String
  avgPatientsPerDay Int
  dateOfBirth       DateTime
  specialty         String
  planId            String?  @unique
  LicenseNumber     String
  latitude          Float?
  longitude         Float?
  isActive          Boolean  @default(true)

  plan   Plan?    @relation(fields: [planId], references: [id])
  region Region[]
  visits Visit[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
